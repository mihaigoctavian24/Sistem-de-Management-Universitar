@page "/admin/users"
@using UniversityManagementSystem.Client.Models
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "admin")]
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Users Management</MudText>

    @if (loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudTable Items="@users" Hover="true" Striped="true" Filter="new Func<ProfileDto,bool>(FilterFunc)">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Users List</MudText>
                <MudSpacer />
                <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Role</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">@context.FullName</MudTd>
                <MudTd DataLabel="Email">@context.Email</MudTd>
                <MudTd DataLabel="Role">
                    <MudChip T="string" Color="@GetRoleColor(context.Role)" Size="Size.Small">@context.Role.ToUpper()</MudChip>
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="@(() => OpenEditDialog(context))" />
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    }
</MudContainer>

<MudDialog @bind-IsVisible="isDialogVisible">
    <TitleContent>
        <MudText Typo="Typo.h6">Edit User Role</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Class="mb-4">Editing user: <b>@currentUser.FullName</b> (@currentUser.Email)</MudText>
        
        <MudSelect T="string" Label="Role" @bind-Value="selectedRole" AnchorOrigin="Origin.BottomCenter" Class="mb-3">
            <MudSelectItem Value="@("student")">Student</MudSelectItem>
            <MudSelectItem Value="@("professor")">Professor</MudSelectItem>
            <MudSelectItem Value="@("admin")">Admin</MudSelectItem>
            <MudSelectItem Value="@("dean")">Dean</MudSelectItem>
            <MudSelectItem Value="@("secretary")">Secretary</MudSelectItem>
        </MudSelect>

        @if (selectedRole == "student")
        {
            <MudSelect T="long" Label="Group" @bind-Value="selectedGroupId" AnchorOrigin="Origin.BottomCenter" Class="mb-3">
                @foreach (var group in groups)
                {
                    <MudSelectItem T="long" Value="@group.Id">@group.Name (@group.ProgramName)</MudSelectItem>
                }
            </MudSelect>
            <MudTextField @bind-Value="registrationNumber" Label="Registration Number" Class="mb-3" />
        }

        @if (selectedRole == "professor" || selectedRole == "dean")
        {
            <MudSelect T="long" Label="Faculty" @bind-Value="selectedFacultyId" AnchorOrigin="Origin.BottomCenter" Class="mb-3">
                @foreach (var faculty in faculties)
                {
                    <MudSelectItem T="long" Value="@faculty.Id">@faculty.Name</MudSelectItem>
                }
            </MudSelect>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDialog">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="SaveUser">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<ProfileDto> users = new();
    private List<GroupDto> groups = new();
    private List<FacultyDto> faculties = new();
    private bool loading = true;
    private string searchString = "";
    
    private bool isDialogVisible;
    private ProfileDto currentUser = new();
    private string selectedRole = "";
    
    // Student specific
    private long selectedGroupId;
    private string registrationNumber = "";
    
    // Professor specific
    private long selectedFacultyId;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            loading = true;
            users = await Http.GetFromJsonAsync<List<ProfileDto>>("api/users") ?? new();
            groups = await Http.GetFromJsonAsync<List<GroupDto>>("api/groups") ?? new();
            faculties = await Http.GetFromJsonAsync<List<FacultyDto>>("api/faculties") ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private Color GetRoleColor(string role)
    {
        return role switch
        {
            "admin" => Color.Error,
            "professor" => Color.Info,
            "dean" => Color.Warning,
            "student" => Color.Success,
            _ => Color.Default
        };
    }

    private bool FilterFunc(ProfileDto user)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (user.FullName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (user.Email.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    private async Task OpenEditDialog(ProfileDto user)
    {
        currentUser = user;
        selectedRole = user.Role;
        
        // Reset fields
        selectedGroupId = 0;
        registrationNumber = "";
        selectedFacultyId = 0;

        // If user is already a student, try to fetch details
        if (user.Role == "student")
        {
            try 
            {
                var studentDetails = await Http.GetFromJsonAsync<StudentDto>($"api/students/{user.Id}");
                if (studentDetails != null)
                {
                    selectedGroupId = studentDetails.GroupId ?? 0;
                    registrationNumber = studentDetails.RegistrationNumber ?? "";
                }
            }
            catch { /* Ignore if not found */ }
        }
        
        // If user is already a professor, try to fetch details
        if (user.Role == "professor" || user.Role == "dean")
        {
            try
            {
                var professorDetails = await Http.GetFromJsonAsync<ProfessorDto>($"api/professors/{user.Id}");
                if (professorDetails != null)
                {
                    selectedFacultyId = professorDetails.FacultyId ?? 0;
                }
            }
            catch { /* Ignore if not found */ }
        }

        // Set defaults if 0
        if (selectedGroupId == 0 && groups.Any()) selectedGroupId = groups.First().Id;
        if (selectedFacultyId == 0 && faculties.Any()) selectedFacultyId = faculties.First().Id;

        isDialogVisible = true;
    }

    private void CloseDialog()
    {
        isDialogVisible = false;
    }

    private async Task SaveUser()
    {
        try
        {
            // 1. Update Role
            var roleResponse = await Http.PutAsJsonAsync($"api/users/{currentUser.Id}/role", new { Role = selectedRole });
            if (!roleResponse.IsSuccessStatusCode)
            {
                Snackbar.Add("Failed to update role", Severity.Error);
                return;
            }

            // 2. Update specific details based on role
            if (selectedRole == "student")
            {
                var studentRequest = new CreateStudentRequest
                {
                    Id = currentUser.Id,
                    GroupId = selectedGroupId,
                    RegistrationNumber = registrationNumber
                };
                await Http.PostAsJsonAsync("api/students", studentRequest);
            }
            else if (selectedRole == "professor" || selectedRole == "dean")
            {
                var professorRequest = new CreateProfessorRequest
                {
                    Id = currentUser.Id,
                    FacultyId = selectedFacultyId
                };
                await Http.PostAsJsonAsync("api/professors", professorRequest);
            }

            Snackbar.Add("User updated successfully", Severity.Success);
            CloseDialog();
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving user: {ex.Message}", Severity.Error);
        }
    }
}
